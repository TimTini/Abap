"use strict";

(function (root) {
  const globalRoot = root || (typeof globalThis !== "undefined" ? globalThis : this);
  const registry = globalRoot.__AbapSourceParts = globalRoot.__AbapSourceParts || {};
  const targetKey = "viewer/app/01-core.js";
  const partKey = "viewer/app/core/01-runtime-state.js";
  const bucket = registry[targetKey] = registry[targetKey] || {};
  bucket[partKey] = "\"use strict\";\n\nwindow.AbapViewerModules = window.AbapViewerModules || {};\nwindow.AbapViewerModules.parts = window.AbapViewerModules.parts || {};\nwindow.AbapViewerRuntime = window.AbapViewerRuntime || {};\nwindow.AbapViewerRuntime.api = window.AbapViewerRuntime.api || {};\n\n  const els = {\n    fileInput: document.getElementById(\"fileInput\"),\n    parseBtn: document.getElementById(\"parseBtn\"),\n    searchInput: document.getElementById(\"searchInput\"),\n    typeFilter: document.getElementById(\"typeFilter\"),\n    showRaw: document.getElementById(\"showRaw\"),\n    showKeywords: document.getElementById(\"showKeywords\"),\n    showValues: document.getElementById(\"showValues\"),\n    showExtras: document.getElementById(\"showExtras\"),\n    themeToggle: document.getElementById(\"themeToggle\"),\n    expandAllBtn: document.getElementById(\"expandAllBtn\"),\n    collapseAllBtn: document.getElementById(\"collapseAllBtn\"),\n    clearFiltersBtn: document.getElementById(\"clearFiltersBtn\"),\n    descBtn: document.getElementById(\"descBtn\"),\n    settingsBtn: document.getElementById(\"settingsBtn\"),\n    exportXmlBtn: document.getElementById(\"exportXmlBtn\"),\n    inputText: document.getElementById(\"inputText\"),\n    inputGutter: document.getElementById(\"inputGutter\"),\n    inputGutterContent: document.getElementById(\"inputGutterContent\"),\n    mainLayout: document.getElementById(\"mainLayout\"),\n    panelSplitter: document.getElementById(\"panelSplitter\"),\n    output: document.getElementById(\"output\"),\n    buildInfo: document.getElementById(\"buildInfo\"),\n    rightPanelTitle: document.getElementById(\"rightPanelTitle\"),\n    rightTabOutputBtn: document.getElementById(\"rightTabOutputBtn\"),\n    rightTabTemplateBtn: document.getElementById(\"rightTabTemplateBtn\"),\n    rightTabDescBtn: document.getElementById(\"rightTabDescBtn\"),\n    templatePreviewPanel: document.getElementById(\"templatePreviewPanel\"),\n    templateKeyMode: document.getElementById(\"templateKeyMode\"),\n    templateCopyTableOnly: document.getElementById(\"templateCopyTableOnly\"),\n    templateCopyAllBtn: document.getElementById(\"templateCopyAllBtn\"),\n    templateResetBtn: document.getElementById(\"templateResetBtn\"),\n    templateExportBtn: document.getElementById(\"templateExportBtn\"),\n    templateImportBtn: document.getElementById(\"templateImportBtn\"),\n    templateApplyBtn: document.getElementById(\"templateApplyBtn\"),\n    templateImportInput: document.getElementById(\"templateImportInput\"),\n    templateConfigError: document.getElementById(\"templateConfigError\"),\n    templateConfigJson: document.getElementById(\"templateConfigJson\"),\n    templatePreviewOutput: document.getElementById(\"templatePreviewOutput\"),\n    declDescJsonBtn: document.getElementById(\"declDescJsonBtn\"),\n    declDescPanel: document.getElementById(\"declDescPanel\"),\n    error: document.getElementById(\"error\"),\n    jsonModal: document.getElementById(\"jsonModal\"),\n    jsonTitle: document.getElementById(\"jsonTitle\"),\n    jsonPre: document.getElementById(\"jsonPre\"),\n    jsonCopyBtn: document.getElementById(\"jsonCopyBtn\"),\n    jsonCloseBtn: document.getElementById(\"jsonCloseBtn\"),\n    declDescSearch: document.getElementById(\"declDescSearch\"),\n    declDescMissingOnly: document.getElementById(\"declDescMissingOnly\"),\n    declDescTypes: document.getElementById(\"declDescTypes\"),\n    declDescSummary: document.getElementById(\"declDescSummary\"),\n    declDescTable: document.getElementById(\"declDescTable\"),\n    editModal: document.getElementById(\"editModal\"),\n    editLabel: document.getElementById(\"editLabel\"),\n    editHint: document.getElementById(\"editHint\"),\n    editSingleWrap: document.getElementById(\"editSingleWrap\"),\n    editDesc: document.getElementById(\"editDesc\"),\n    editStructWrap: document.getElementById(\"editStructWrap\"),\n    editStructDesc: document.getElementById(\"editStructDesc\"),\n    editItemDesc: document.getElementById(\"editItemDesc\"),\n    editSkipNormalize: document.getElementById(\"editSkipNormalize\"),\n    editSaveBtn: document.getElementById(\"editSaveBtn\"),\n    editClearBtn: document.getElementById(\"editClearBtn\"),\n    editCancelBtn: document.getElementById(\"editCancelBtn\"),\n    rulesBtn: document.getElementById(\"rulesBtn\"),\n    rulesModal: document.getElementById(\"rulesModal\"),\n    rulesSelect: document.getElementById(\"rulesSelect\"),\n    rulesTemplate: document.getElementById(\"rulesTemplate\"),\n    rulesError: document.getElementById(\"rulesError\"),\n    rulesJson: document.getElementById(\"rulesJson\"),\n    rulesNewBtn: document.getElementById(\"rulesNewBtn\"),\n    rulesSaveBtn: document.getElementById(\"rulesSaveBtn\"),\n    rulesDeleteBtn: document.getElementById(\"rulesDeleteBtn\"),\n    rulesDownloadBtn: document.getElementById(\"rulesDownloadBtn\"),\n    rulesCloseBtn: document.getElementById(\"rulesCloseBtn\"),\n    settingsModal: document.getElementById(\"settingsModal\"),\n    settingsNormalizeDesc: document.getElementById(\"settingsNormalizeDesc\"),\n    settingsDeclTypes: document.getElementById(\"settingsDeclTypes\"),\n    settingsStructTemplate: document.getElementById(\"settingsStructTemplate\"),\n    settingsNameTemplates: document.getElementById(\"settingsNameTemplates\"),\n    settingsSaveBtn: document.getElementById(\"settingsSaveBtn\"),\n    settingsResetBtn: document.getElementById(\"settingsResetBtn\"),\n    settingsCloseBtn: document.getElementById(\"settingsCloseBtn\")\n  };\n\n  const state = {\n    data: null,\n    renderObjects: [],\n    inputMode: \"abap\",\n    inputLineCount: 0,\n    inputGutterButtonsByLine: new Map(),\n    inputGutterTargetsByLine: new Map(),\n    theme: \"dark\",\n    query: \"\",\n    type: \"\",\n    showRaw: true,\n    showKeywords: true,\n    showValues: true,\n    showExtras: false,\n    rightTab: \"output\",\n    templateConfig: null,\n    templateConfigDraft: \"\",\n    templatePreviewCache: null,\n    collapsedIds: new Set(),\n    selectedId: \"\",\n    selectedTemplateIndex: \"\",\n    selectedDeclKey: \"\",\n    descOverrides: {},\n    descOverridesLegacy: {},\n    activeEdit: null,\n    haystackById: new Map(),\n    inputLineOffsets: [],\n    customRules: [],\n    activeRuleId: \"\",\n    settings: null,\n    layoutLeftPane: 48\n  };\n\n  const DESC_STORAGE_KEY_V2 = \"abap-parser-viewer.declDescOverrides.v2\";\n  const DESC_STORAGE_KEY_LEGACY_V1 = \"abap-parser-viewer.descOverrides.v1\";\n  const RULES_STORAGE_KEY_V1 = \"abap-parser-viewer.customConfigs.v1\";\n  const SETTINGS_STORAGE_KEY_V1 = \"abap-parser-viewer.settings.v1\";\n  const TEMPLATE_CONFIG_STORAGE_KEY_V1 = \"abap-parser-viewer.templateConfig.v1\";\n  const THEME_STORAGE_KEY_V1 = \"abap-parser-viewer.theme.v1\";\n  const LAYOUT_SPLIT_STORAGE_KEY_V1 = \"abap-parser-viewer.layoutSplit.v1\";\n  const LAYOUT_SPLIT_DEFAULT = 48;\n  const LAYOUT_SPLIT_MIN = 28;\n  const LAYOUT_SPLIT_MAX = 72;\n  const MOBILE_LAYOUT_QUERY = \"(max-width: 980px)\";\n  const RENDER_TREE_OPTIONS = Object.freeze({\n    expandPerformForms: true,\n    hideFormRoots: true,\n    maxExpandDepth: Number.POSITIVE_INFINITY\n  });\n\n  const DECL_TYPE_OPTIONS = [\n    \"DATA\",\n    \"TYPES\",\n    \"PARAMETERS\",\n    \"SELECT-OPTIONS\",\n    \"CONSTANTS\",\n    \"RANGES\",\n    \"STATICS\",\n    \"CLASS-DATA\",\n    \"FIELD-SYMBOLS\"\n  ];\n\n  const NAME_CODE_OPTIONS = [\n    { code: \"CN\", label: \"HẰNG\" },\n    { code: \"DS\", label: \"STRUCT\" },\n    { code: \"DT\", label: \"TABLE\" },\n    { code: \"DR\", label: \"RANGETABLE\" },\n    { code: \"DF\", label: \"BIẾN\" },\n    { code: \"FL\", label: \"CỜ\" },\n    { code: \"FS\", label: \"FIELDSYMBOL\" }\n  ];\n\n  const DEFAULT_SETTINGS = {\n    normalizeDeclDesc: true,\n    declFilterTypes: [\"DATA\", \"TYPES\", \"PARAMETERS\"],\n    structDescTemplate: \"{{struct}}-{{item}}\",\n    nameTemplatesByCode: {\n      CN: \"HẰNG:{{desc}}\",\n      DS: \"STRUCT:{{desc}}\",\n      DT: \"TABLE:{{desc}}\",\n      DR: \"RANGETABLE:{{desc}}\",\n      DF: \"BIẾN:{{desc}}\",\n      FL: \"CỜ:{{desc}}\",\n      FS: \"FIELDSYMBOL:{{desc}}\"\n    }\n  };\n\n  const SAMPLE_ABAP = [\n    \"* ABAP Parser Viewer - richer offline demo\",\n    \"REPORT zabap_parser_demo.\",\n    \"\",\n    \"* Comment parsing checks\",\n    \"* ---- decorative separator (should behave like blank)\",\n    \"\\\" ---- decorative quote-comment separator\",\n    \"* Single leading comment should map to next statement\",\n    \"DATA lv_comment_demo TYPE string. \\\"Inline comment for comment test\",\n    \"lv_comment_demo = 'CHECK'. \\\"Inline assignment comment\",\n    \"\",\n    \"* Selection screen\",\n    \"PARAMETERS p_user TYPE syuname DEFAULT sy-uname OBLIGATORY. \\\"User name input\",\n    \"PARAMETERS p_flag TYPE abap_bool DEFAULT abap_true AS CHECKBOX. \\\"Enable branch\",\n    \"SELECT-OPTIONS s_bukrs FOR t001-bukrs.\",\n    \"\",\n    \"* Types + declarations\",\n    \"TYPES: BEGIN OF ty_row,\",\n    \"         bukrs TYPE t001-bukrs,\",\n    \"         butxt TYPE t001-butxt,\",\n    \"       END OF ty_row.\",\n    \"TYPES: BEGIN OF ty_user,\",\n    \"         uname TYPE syuname,\",\n    \"         active TYPE abap_bool,\",\n    \"         role TYPE string,\",\n    \"       END OF ty_user.\",\n    \"TYPES: BEGIN OF ty_pair,\",\n    \"         a TYPE string,\",\n    \"         b TYPE string,\",\n    \"       END OF ty_pair.\",\n    \"TYPES ty_rows TYPE STANDARD TABLE OF ty_row.\",\n    \"TYPES ty_users TYPE STANDARD TABLE OF ty_user.\",\n    \"\",\n    \"DATA: gt_rows TYPE ty_rows,\",\n    \"      gs_row  TYPE ty_row,\",\n    \"      lt_users TYPE ty_users,\",\n    \"      ls_user TYPE ty_user,\",\n    \"      LDS_pair TYPE ty_pair,\",\n    \"      gv_total TYPE i VALUE 0,\",\n    \"      lv_active TYPE abap_bool VALUE abap_true,\",\n    \"      lv_role TYPE string VALUE 'ADMIN',\",\n    \"      lv_text TYPE string,\",\n    \"      lo_demo TYPE REF TO lcl_demo.\",\n    \"CONSTANTS gc_default_bukrs TYPE t001-bukrs VALUE '1000'.\",\n    \"FIELD-SYMBOLS <fs_row> TYPE ty_row.\",\n    \"\",\n    \"* Open SQL + table ops\",\n    \"SELECT bukrs butxt FROM t001 INTO TABLE gt_rows WHERE bukrs IN s_bukrs.\",\n    \"READ TABLE gt_rows WITH KEY bukrs = gc_default_bukrs INTO gs_row.\",\n    \"READ TABLE gt_rows WITH TABLE KEY primary_key COMPONENTS bukrs = gc_default_bukrs INTO gs_row.\",\n    \"READ TABLE lt_users WITH KEY uname = p_user active = lv_active INTO ls_user.\",\n    \"READ TABLE lt_users WITH KEY uname = p_user active = lv_active role = lv_role INTO ls_user.\",\n    \"MODIFY gt_rows FROM gs_row TRANSPORTING butxt WHERE bukrs = gc_default_bukrs.\",\n    \"DELETE gt_rows WHERE bukrs = gc_default_bukrs.\",\n    \"\",\n    \"LOOP AT gt_rows ASSIGNING <fs_row> WHERE bukrs = gc_default_bukrs.\",\n    \"  gv_total = gv_total + 1.\",\n    \"ENDLOOP.\",\n    \"LOOP AT lt_users INTO ls_user\",\n    \"  WHERE uname = p_user\",\n    \"    AND active = lv_active\",\n    \"    AND role = lv_role.\",\n    \"  gv_total = gv_total + 1.\",\n    \"ENDLOOP.\",\n    \"\",\n    \"* Conditions\",\n    \"IF gv_total > 0 AND p_flag = abap_true.\",\n    \"  lv_text = p_user.\",\n    \"ELSEIF gv_total IS INITIAL.\",\n    \"  lv_text = 'EMPTY'.\",\n    \"ELSE.\",\n    \"  lv_text = 'OTHER'.\",\n    \"ENDIF.\",\n    \"\",\n    \"* Classic calls\",\n    \"CALL FUNCTION 'Z_DEMO_FM'\",\n    \"  EXPORTING\",\n    \"    iv_user = p_user\",\n    \"  IMPORTING\",\n    \"    ev_text = lv_text\",\n    \"  CHANGING\",\n    \"    cv_cnt = gv_total\",\n    \"  TABLES\",\n    \"    et_rows = gt_rows\",\n    \"  EXCEPTIONS\",\n    \"    text_error = 2\",\n    \"    error_message = 3\",\n    \"    OTHERS = 1.\",\n    \"\",\n    \"* Struct field normalization check (a-b)\",\n    \"* Expectation for normalized desc: STRUCT:a-b (NOT STRUCT:a-STRUCT:b)\",\n    \"LDS_pair-a = p_user. \\\"Struct field a source\",\n    \"LDS_pair-b = lv_role. \\\"Struct field b source\",\n    \"lv_text = LDS_pair-a. \\\"Struct field readback\",\n    \"\",\n    \"CALL METHOD lo_demo->do_something\",\n    \"  EXPORTING\",\n    \"    iv_user = p_user\",\n    \"  IMPORTING\",\n    \"    ev_text = lv_text.\",\n    \"\",\n    \"* New method-call expressions (=> and ->)\",\n    \"lv_text = lcl_demo=>get_default( ).\",\n    \"lo_demo->do_something( EXPORTING iv_user = p_user IMPORTING ev_text = lv_text ).\",\n    \"\",\n    \"* MESSAGE demo (class/number/type/display like/with/into)\",\n    \"MESSAGE ID '00' TYPE 'S' NUMBER '001' WITH p_user lv_role gv_total lv_text DISPLAY LIKE 'I' INTO lv_text.\",\n    \"\",\n    \"* PERFORM + FORM\",\n    \"PERFORM main USING p_user p_flag CHANGING lv_text IF p_flag = abap_true.\",\n    \"PERFORM main IN PROGRAM sy-repid USING p_user p_flag CHANGING lv_text IF p_flag = abap_true.\",\n    \"\",\n    \"FORM main\",\n    \"  USING iv_user TYPE syuname\",\n    \"        iv_flag TYPE abap_bool\",\n    \"  CHANGING cv_text TYPE string.\",\n    \"  cv_text = iv_user.\",\n    \"ENDFORM.\",\n    \"\",\n    \"* Local class\",\n    \"CLASS lcl_demo DEFINITION.\",\n    \"  PUBLIC SECTION.\",\n    \"    METHODS do_something IMPORTING iv_user TYPE syuname EXPORTING ev_text TYPE string.\",\n    \"    CLASS-METHODS get_default RETURNING VALUE(rv_text) TYPE string.\",\n    \"ENDCLASS.\",\n    \"\",\n    \"CLASS lcl_demo IMPLEMENTATION.\",\n    \"  METHOD do_something.\",\n    \"    ev_text = iv_user.\",\n    \"  ENDMETHOD.\",\n    \"\",\n    \"  METHOD get_default.\",\n    \"    rv_text = 'DEFAULT'.\",\n    \"  ENDMETHOD.\",\n    \"ENDCLASS.\"\n  ].join(\"\\n\");\n\n  function createTemplateBaseStyle(background) {\n    return {\n      background: background || \"default\",\n      border: \"outside-thin\",\n      font: \"MS PGothic\",\n      \"font color\": \"#111111\",\n      \"font size\": 10,\n      \"font family\": \"default\",\n      bold: false,\n      italic: false,\n      underline: false,\n      merge: false,\n      align: \"left\",\n      valign: \"top\",\n      wrap: false\n    };\n  }\n\n  const TEMPLATE_PREVIEW_DEFAULT_OPTIONS = {\n    hideEmptyRows: true,\n    hideRowsWithoutValues: true,\n    expandMultilineRows: true,\n    squareCells: true,\n    squareCellSize: 18\n  };\n\n  function createGenericStatementTemplate(templateKey) {\n    const keyText = String(templateKey || \"\").trim();\n    return {\n      _options: { ...TEMPLATE_PREVIEW_DEFAULT_OPTIONS },\n      \"A1:G1\": createTemplateBaseStyle(\"#dbeef4\"),\n      A1: {\n        text: \"Câu lệnh\"\n      },\n      \"H1:AY1\": createTemplateBaseStyle(\"default\"),\n      H1: {\n        text: \"{keywords.stmt.text}{objectType}\"\n      },\n      \"A2:G2\": createTemplateBaseStyle(\"#dbeef4\"),\n      A2: {\n        text: \"Đối tượng\"\n      },\n      \"H2:AY2\": createTemplateBaseStyle(\"default\"),\n      H2: {\n        text: \"{values.name.finalDesc}{values.target.finalDesc}{values.form.finalDesc}{values.itab.finalDesc}{values.itabOrDbtab.finalDesc}\"\n      },\n      \"A3:G3\": createTemplateBaseStyle(\"#dbeef4\"),\n      A3: {\n        text: \"Nguồn / Đích\"\n      },\n      \"H3:AY3\": createTemplateBaseStyle(\"default\"),\n      H3: {\n        text: \"{values.into.finalDesc}{values.from.finalDesc}{values.index.value}\"\n      },\n      \"A4:G4\": createTemplateBaseStyle(\"#dbeef4\"),\n      A4: {\n        text: \"Điều kiện\"\n      },\n      \"H4:AY4\": createTemplateBaseStyle(\"default\"),\n      H4: {\n        text: \"{values.condition.finalDesc}{values.where.finalDesc}{values.withKey.finalDesc}{values.withTableKey.finalDesc}\"\n      },\n      \"A5:G5\": createTemplateBaseStyle(\"#dbeef4\"),\n      A5: {\n        text: \"Chi tiết\"\n      },\n      \"H5:AY5\": createTemplateBaseStyle(\"default\"),\n      H5: {\n        text: \"{extras}\"\n      },\n      \"A6:G6\": createTemplateBaseStyle(\"#dbeef4\"),\n      A6: {\n        text: \"Template key\"\n      },\n      \"H6:AY6\": createTemplateBaseStyle(\"default\"),\n      H6: {\n        text: keyText\n      }\n    };\n  }\n\n  const TEMPLATE_DEFAULT_CONFIG_V1 = {\n    version: 1,\n    templates: {\n      DEFAULT: {\n        _options: {\n          hideEmptyRows: true,\n          hideRowsWithoutValues: true,\n          expandMultilineRows: false\n        },\n        \"A1:F1\": {\n          background: \"mau xanh nhat\",\n          border: \"outside-thin\",\n          font: \"MS PGothic\",\n          \"font color\": \"#111111\",\n          \"font size\": 10,\n          \"font family\": \"default\",\n          bold: false,\n          italic: false,\n          underline: false,\n          merge: false,\n          align: \"left\",\n          valign: \"top\",\n          wrap: false\n        },\n        A1: {\n          text: \"{keywords.stmt.text}\"\n        },\n        \"G1:W1\": {\n          background: \"#ffffff\",\n          border: \"outside-thin\",\n          font: \"MS PGothic\",\n          \"font color\": \"#111111\",\n          \"font size\": 10,\n          \"font family\": \"default\",\n          bold: false,\n          italic: false,\n          underline: false,\n          merge: false,\n          align: \"left\",\n          valign: \"top\",\n          wrap: false\n        },\n        G1: {\n          text: \"{values.name.finalDesc}\"\n        }\n      },\n      ASSIGNMENT: {\n        \"A1:F1\": {\n          background: \"mau xanh nhat\",\n          border: \"outside-thin\",\n          font: \"MS PGothic\",\n          \"font color\": \"#111111\",\n          \"font size\": 10,\n          \"font family\": \"default\",\n";
})(typeof globalThis !== "undefined" ? globalThis : (typeof self !== "undefined" ? self : this));
