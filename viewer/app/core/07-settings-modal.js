"use strict";

(function (root) {
  const globalRoot = root || (typeof globalThis !== "undefined" ? globalThis : this);
  const registry = globalRoot.__AbapSourceParts = globalRoot.__AbapSourceParts || {};
  const targetKey = "viewer/app/01-core.js";
  const partKey = "viewer/app/core/07-settings-modal.js";
  const bucket = registry[targetKey] = registry[targetKey] || {};
  bucket[partKey] = "        continue;\n      }\n\n      if (item.config && typeof item.config === \"object\" && !Array.isArray(item.config)) {\n        const id = item.id ? String(item.id) : generateRuleId();\n        output.push({ id, config: item.config });\n        continue;\n      }\n\n      if (typeof item.object === \"string\") {\n        output.push({ id: generateRuleId(), config: item });\n      }\n    }\n\n    return output;\n  }\n\n  function loadCustomRules() {\n    return normalizeCustomRules(loadStorageArray(RULES_STORAGE_KEY_V1));\n  }\n\n  function saveCustomRules() {\n    try {\n      localStorage.setItem(RULES_STORAGE_KEY_V1, JSON.stringify(state.customRules || []));\n    } catch {\n      // ignore\n    }\n  }\n\n  function setRulesError(message) {\n    if (!els.rulesError) {\n      return;\n    }\n    els.rulesError.textContent = message ? String(message) : \"\";\n  }\n\n  function getCustomConfigs() {\n    const output = [];\n    for (const rule of state.customRules || []) {\n      if (!rule || !rule.config) {\n        continue;\n      }\n      const error = validateRuleConfig(rule.config);\n      if (!error) {\n        output.push(rule.config);\n      }\n    }\n    return output;\n  }\n\n  function describeRuleOption(rule) {\n    if (!rule || !rule.config) {\n      return \"(invalid rule)\";\n    }\n\n    const objectType = rule.config.object ? String(rule.config.object) : \"RULE\";\n    const match = rule.config.match && typeof rule.config.match === \"object\" ? rule.config.match : {};\n    const summary = match.startPhrase\n      ? `startPhrase=${String(match.startPhrase)}`\n      : match.startKeyword\n        ? `startKeyword=${String(match.startKeyword)}`\n        : match.type\n          ? `type=${String(match.type)}`\n          : \"match=?\";\n\n    return `${objectType} (${summary})`;\n  }\n\n  function renderRulesSelect() {\n    if (!els.rulesSelect) {\n      return;\n    }\n\n    els.rulesSelect.replaceChildren();\n    els.rulesSelect.appendChild(el(\"option\", { text: \"(New rule)\", attrs: { value: \"\" } }));\n\n    for (const rule of state.customRules || []) {\n      const id = rule && rule.id ? String(rule.id) : \"\";\n      if (!id) {\n        continue;\n      }\n      els.rulesSelect.appendChild(\n        el(\"option\", {\n          text: describeRuleOption(rule),\n          attrs: { value: id }\n        })\n      );\n    }\n\n    els.rulesSelect.value = state.activeRuleId || \"\";\n  }\n\n  function selectRule(ruleId) {\n    const id = ruleId ? String(ruleId) : \"\";\n    state.activeRuleId = id;\n    setRulesError(\"\");\n\n    if (!els.rulesJson) {\n      return;\n    }\n\n    if (!id) {\n      els.rulesJson.value = \"\";\n      return;\n    }\n\n    const rule = (state.customRules || []).find((r) => r && String(r.id) === id) || null;\n    if (!rule || !rule.config) {\n      els.rulesJson.value = \"\";\n      return;\n    }\n\n    try {\n      els.rulesJson.value = JSON.stringify(rule.config, null, 2);\n    } catch {\n      els.rulesJson.value = \"\";\n    }\n  }\n\n  function createRuleTemplate(kind) {\n    const type = String(kind || \"startKeyword\");\n\n    if (type === \"assignment\") {\n      return {\n        object: \"ASSIGNMENT\",\n        match: { type: \"assignment\" },\n        keywordLabels: {\n          \"=\": \"assign\",\n          \"+=\": \"add-assign\",\n          \"-=\": \"sub-assign\",\n          \"*=\": \"mul-assign\",\n          \"/=\": \"div-assign\",\n          \"?=\": \"cast\"\n        },\n        keywordPhrases: {},\n        captureRules: []\n      };\n    }\n\n    if (type === \"startPhrase\") {\n      return {\n        object: \"MY_OBJECT\",\n        match: { startPhrase: \"MY PHRASE\" },\n        keywordLabels: {\n          MY: \"stmt\"\n        },\n        keywordPhrases: {\n          \"MY PHRASE\": \"my-phrase\"\n        },\n        captureRules: [\n          { after: \"MY PHRASE\", name: \"name\", label: \"name\" }\n        ]\n      };\n    }\n\n    return {\n      object: \"MY_OBJECT\",\n      match: { startKeyword: \"MYKEYWORD\" },\n      keywordLabels: {\n        MYKEYWORD: \"stmt\"\n      },\n      keywordPhrases: {},\n      captureRules: [\n        { after: \"MYKEYWORD\", name: \"name\", label: \"name\" }\n      ]\n    };\n  }\n\n  function startNewRule() {\n    state.activeRuleId = \"\";\n    if (els.rulesSelect) {\n      els.rulesSelect.value = \"\";\n    }\n\n    const kind = els.rulesTemplate ? els.rulesTemplate.value : \"startKeyword\";\n    const template = createRuleTemplate(kind);\n\n    if (els.rulesJson) {\n      els.rulesJson.value = JSON.stringify(template, null, 2);\n      els.rulesJson.focus();\n    }\n\n    setRulesError(\"\");\n  }\n\n  function readRuleFromEditor() {\n    const text = els.rulesJson ? els.rulesJson.value || \"\" : \"\";\n    const trimmed = text.trim();\n    if (!trimmed) {\n      return { config: null, error: \"Rule JSON is empty.\" };\n    }\n\n    try {\n      const parsed = JSON.parse(trimmed);\n      const config = parsed;\n      const error = validateRuleConfig(config);\n      if (error) {\n        return { config: null, error };\n      }\n      return { config, error: \"\" };\n    } catch (err) {\n      return { config: null, error: `JSON parse error: ${err && err.message ? err.message : err}` };\n    }\n  }\n\n  function saveRuleFromEditor() {\n    const { config, error } = readRuleFromEditor();\n    if (error) {\n      setRulesError(error);\n      return;\n    }\n\n    setRulesError(\"\");\n\n    if (state.activeRuleId) {\n      const target = (state.customRules || []).find((r) => r && String(r.id) === state.activeRuleId) || null;\n      if (target) {\n        target.config = config;\n      } else {\n        state.customRules.push({ id: state.activeRuleId, config });\n      }\n    } else {\n      const id = generateRuleId();\n      state.customRules.push({ id, config });\n      state.activeRuleId = id;\n    }\n\n    saveCustomRules();\n    renderRulesSelect();\n    if (els.rulesSelect) {\n      els.rulesSelect.value = state.activeRuleId || \"\";\n    }\n  }\n\n  function deleteActiveRule() {\n    if (!state.activeRuleId) {\n      setRulesError(\"Select a saved rule to delete.\");\n      return;\n    }\n\n    state.customRules = (state.customRules || []).filter((r) => r && String(r.id) !== state.activeRuleId);\n    state.activeRuleId = \"\";\n    saveCustomRules();\n    renderRulesSelect();\n    if (els.rulesJson) {\n      els.rulesJson.value = \"\";\n    }\n    setRulesError(\"\");\n  }\n\n  function downloadRuleFromEditor() {\n    const { config, error } = readRuleFromEditor();\n    if (error) {\n      setRulesError(error);\n      return;\n    }\n\n    setRulesError(\"\");\n\n    const fileBase = config && config.object ? String(config.object).trim() : \"rule\";\n    const fileName = `${fileBase}.json`;\n    const content = JSON.stringify(config, null, 2);\n\n    try {\n      const blob = new Blob([content], { type: \"application/json\" });\n      const url = URL.createObjectURL(blob);\n      const a = document.createElement(\"a\");\n      a.href = url;\n      a.download = fileName;\n      document.body.appendChild(a);\n      a.click();\n      a.remove();\n      URL.revokeObjectURL(url);\n    } catch (err) {\n      setRulesError(`Download failed: ${err && err.message ? err.message : err}`);\n    }\n  }\n\n  function openRulesModal() {\n    if (!els.rulesModal) {\n      return;\n    }\n\n    if (!els.jsonModal.hidden) {\n      closeJsonModal();\n    }\n    if (!els.editModal.hidden) {\n      closeEditModal();\n    }\n\n    renderRulesSelect();\n    if (state.activeRuleId) {\n      selectRule(state.activeRuleId);\n    } else if (els.rulesJson && !els.rulesJson.value.trim()) {\n      startNewRule();\n    }\n\n    els.rulesModal.hidden = false;\n  }\n\n  function closeRulesModal() {\n    if (!els.rulesModal) {\n      return;\n    }\n\n    els.rulesModal.hidden = true;\n    setRulesError(\"\");\n  }\n\n  function renderSettingsModalUi() {\n    if (!els.settingsModal) {\n      return;\n    }\n\n    const settings = state.settings || loadSettings();\n    state.settings = settings;\n\n    if (els.settingsNormalizeDesc) {\n      els.settingsNormalizeDesc.checked = Boolean(settings.normalizeDeclDesc);\n    }\n\n    if (els.settingsDeclTypes) {\n      els.settingsDeclTypes.replaceChildren();\n      for (const type of DECL_TYPE_OPTIONS) {\n        const label = document.createElement(\"label\");\n        label.className = \"toggle\";\n\n        const input = document.createElement(\"input\");\n        input.type = \"checkbox\";\n        input.value = type;\n        input.checked = Array.isArray(settings.declFilterTypes) && settings.declFilterTypes.includes(type);\n\n        label.appendChild(input);\n        label.appendChild(document.createTextNode(type));\n        els.settingsDeclTypes.appendChild(label);\n      }\n    }\n\n    if (els.settingsStructTemplate) {\n      els.settingsStructTemplate.value = settings.structDescTemplate || DEFAULT_SETTINGS.structDescTemplate;\n    }\n\n    if (els.settingsNameTemplates) {\n      els.settingsNameTemplates.replaceChildren();\n\n      const table = document.createElement(\"table\");\n      const thead = document.createElement(\"thead\");\n      const headRow = document.createElement(\"tr\");\n      for (const title of [\"code\", \"label\", \"template\"]) {\n        const th = document.createElement(\"th\");\n        th.textContent = title;\n        headRow.appendChild(th);\n      }\n      thead.appendChild(headRow);\n      table.appendChild(thead);\n\n      const tbody = document.createElement(\"tbody\");\n      for (const opt of NAME_CODE_OPTIONS) {\n        const tr = document.createElement(\"tr\");\n\n        const codeCell = document.createElement(\"td\");\n        codeCell.textContent = opt.code;\n        tr.appendChild(codeCell);\n\n        const labelCell = document.createElement(\"td\");\n        labelCell.textContent = opt.label;\n        tr.appendChild(labelCell);\n\n        const tplCell = document.createElement(\"td\");\n        const input = document.createElement(\"input\");\n        input.type = \"text\";\n        input.style.width = \"100%\";\n        input.setAttribute(\"data-code\", opt.code);\n        input.value = (settings.nameTemplatesByCode && settings.nameTemplatesByCode[opt.code])\n          ? String(settings.nameTemplatesByCode[opt.code] || \"\")\n          : String(DEFAULT_SETTINGS.nameTemplatesByCode[opt.code] || \"\");\n\n        tplCell.appendChild(input);\n        tr.appendChild(tplCell);\n\n        tbody.appendChild(tr);\n      }\n      table.appendChild(tbody);\n\n      els.settingsNameTemplates.appendChild(table);\n    }\n  }\n\n  function openSettingsModal() {\n    if (!els.settingsModal) {\n      return;\n    }\n\n    if (!els.jsonModal.hidden) {\n      closeJsonModal();\n    }\n    if (!els.editModal.hidden) {\n      closeEditModal();\n    }\n    if (els.rulesModal && !els.rulesModal.hidden) {\n      closeRulesModal();\n    }\n\n    renderSettingsModalUi();\n    els.settingsModal.hidden = false;\n  }\n\n  function closeSettingsModal() {\n    if (!els.settingsModal) {\n      return;\n    }\n    els.settingsModal.hidden = true;\n  }\n\nwindow.AbapViewerModules.factories = window.AbapViewerModules.factories || {};\nwindow.AbapViewerModules.factories[\"01-core\"] = function registerCore(runtime) {\n  const targetRuntime = runtime || (window.AbapViewerRuntime = window.AbapViewerRuntime || {});\n  targetRuntime.api = targetRuntime.api || {};\n  targetRuntime.els = els;\n  targetRuntime.state = state;\n  targetRuntime.constants = {\n    DESC_STORAGE_KEY_V2,\n    DESC_STORAGE_KEY_LEGACY_V1,\n    RULES_STORAGE_KEY_V1,\n    SETTINGS_STORAGE_KEY_V1,\n    TEMPLATE_CONFIG_STORAGE_KEY_V1,\n    THEME_STORAGE_KEY_V1,\n    LAYOUT_SPLIT_STORAGE_KEY_V1,\n    LAYOUT_SPLIT_DEFAULT,\n    LAYOUT_SPLIT_MIN,\n    LAYOUT_SPLIT_MAX,\n    MOBILE_LAYOUT_QUERY,\n    RENDER_TREE_OPTIONS,\n    DECL_TYPE_OPTIONS,\n    NAME_CODE_OPTIONS,\n    DEFAULT_SETTINGS,\n    TEMPLATE_DEFAULT_CONFIG_V1,\n    SAMPLE_ABAP\n  };\n  window.AbapViewerModules.parts[\"01-core\"] = true;\n};\nwindow.AbapViewerModules.factories[\"01-core\"](window.AbapViewerRuntime);\n\n\n";
})(typeof globalThis !== "undefined" ? globalThis : (typeof self !== "undefined" ? self : this));
