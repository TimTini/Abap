"use strict";

(function (root) {
  const globalRoot = root || (typeof globalThis !== "undefined" ? globalThis : this);
  const registry = globalRoot.__AbapSourceParts = globalRoot.__AbapSourceParts || {};
  const targetKey = "viewer/app/02-descriptions.js";
  const partKey = "viewer/app/descriptions/01-normalize-and-desc.js";
  const bucket = registry[targetKey] = registry[targetKey] || {};
  bucket[partKey] = "\"use strict\";\n\nwindow.AbapViewerModules = window.AbapViewerModules || {};\nwindow.AbapViewerModules.parts = window.AbapViewerModules.parts || {};\n\n  function collectConditionDeclsFromClauses(clauses, addDecl) {\n    const list = Array.isArray(clauses) ? clauses : [];\n    for (const clause of list) {\n      if (!clause || typeof clause !== \"object\") {\n        continue;\n      }\n      addDecl(clause.leftOperandDecl);\n      addDecl(clause.rightOperandDecl);\n    }\n  }\n\n  function collectConditionDeclsFromExtras(extras, addDecl) {\n    if (!extras || typeof extras !== \"object\" || typeof addDecl !== \"function\") {\n      return;\n    }\n\n    if (extras.ifCondition) {\n      collectConditionDeclsFromClauses(extras.ifCondition.conditions, addDecl);\n    }\n\n    if (extras.performCall) {\n      collectConditionDeclsFromClauses(extras.performCall.ifConditions, addDecl);\n    }\n\n    if (extras.select) {\n      collectConditionDeclsFromClauses(extras.select.whereConditions, addDecl);\n      collectConditionDeclsFromClauses(extras.select.havingConditions, addDecl);\n    }\n\n    for (const key of [\"readTable\", \"loopAtItab\", \"modifyItab\", \"deleteItab\"]) {\n      if (extras[key]) {\n        collectConditionDeclsFromClauses(extras[key].conditions, addDecl);\n      }\n    }\n  }\n\n  function getDeclsForDescriptionsModal() {\n    if (state.data && typeof state.data === \"object\" && Array.isArray(state.data.decls)) {\n      return state.data.decls;\n    }\n\n    const decls = [];\n    const seen = new Set();\n\n    const addDecl = (decl) => {\n      if (!decl || typeof decl !== \"object\") {\n        return;\n      }\n      const key = getDeclOverrideStorageKey(decl) || stringifyDecl(decl);\n      if (!key || seen.has(key)) {\n        return;\n      }\n      seen.add(key);\n      decls.push(decl);\n    };\n\n    walkObjects(state.data && Array.isArray(state.data.objects) ? state.data.objects : [], (obj) => {\n      for (const value of getValueEntries(obj)) {\n        addDecl(value && value.decl);\n      }\n\n      const extras = obj && obj.extras && typeof obj.extras === \"object\" ? obj.extras : null;\n      if (!extras) {\n        return;\n      }\n\n      const collectFromAssignmentSections = (container, sections) => {\n        for (const sectionName of sections) {\n          const list = container && Array.isArray(container[sectionName]) ? container[sectionName] : [];\n          for (const entry of list) {\n            const origin = entry && Array.isArray(entry.originDecls) ? entry.originDecls : [];\n            for (const originDecl of origin) {\n              addDecl(originDecl);\n            }\n            addDecl(entry && entry.valueDecl);\n          }\n        }\n      };\n\n      if (extras.callFunction) {\n        collectFromAssignmentSections(extras.callFunction, [\"exporting\", \"importing\", \"changing\", \"tables\", \"exceptions\"]);\n      }\n\n      if (extras.callMethod) {\n        collectFromAssignmentSections(extras.callMethod, [\"exporting\", \"importing\", \"changing\", \"receiving\", \"exceptions\"]);\n      }\n\n      if (extras.performCall) {\n        for (const sectionName of [\"using\", \"changing\", \"tables\"]) {\n          const list = Array.isArray(extras.performCall[sectionName]) ? extras.performCall[sectionName] : [];\n          for (const entry of list) {\n            const origin = entry && Array.isArray(entry.originDecls) ? entry.originDecls : [];\n            for (const originDecl of origin) {\n              addDecl(originDecl);\n            }\n            addDecl(entry && entry.valueDecl);\n          }\n        }\n      }\n\n      if (extras.form && Array.isArray(extras.form.params)) {\n        for (const param of extras.form.params) {\n          const origin = param && Array.isArray(param.originDecls) ? param.originDecls : [];\n          for (const originDecl of origin) {\n            addDecl(originDecl);\n          }\n        }\n      }\n\n      collectConditionDeclsFromExtras(extras, addDecl);\n    });\n\n    return decls;\n  }\n\n  function getDeclCodeDesc(decl) {\n    const source = getSourceDeclDesc(decl);\n    if (source) {\n      return source;\n    }\n    return getBaseDeclDesc(decl);\n  }\n\n  function renderDeclDescCellLines({ structText, itemText }) {\n    const wrap = document.createElement(\"div\");\n    const structLine = document.createElement(\"div\");\n    const structLabel = document.createElement(\"span\");\n    structLabel.className = \"muted\";\n    structLabel.textContent = \"Struct: \";\n    structLine.appendChild(structLabel);\n    structLine.appendChild(document.createTextNode(structText || \"\"));\n    wrap.appendChild(structLine);\n\n    const itemLine = document.createElement(\"div\");\n    const itemLabel = document.createElement(\"span\");\n    itemLabel.className = \"muted\";\n    itemLabel.textContent = \"Item: \";\n    itemLine.appendChild(itemLabel);\n    itemLine.appendChild(document.createTextNode(itemText || \"\"));\n    wrap.appendChild(itemLine);\n\n    return wrap;\n  }\n\n  function renderDeclDescPanelUi() {\n    if (!els.declDescPanel) {\n      return;\n    }\n\n    const settings = state.settings || loadSettings();\n    state.settings = settings;\n\n    if (els.declDescTypes) {\n      els.declDescTypes.replaceChildren();\n      for (const type of DECL_TYPE_OPTIONS) {\n        const label = document.createElement(\"label\");\n        label.className = \"toggle\";\n\n        const input = document.createElement(\"input\");\n        input.type = \"checkbox\";\n        input.value = type;\n        input.checked = Array.isArray(settings.declFilterTypes) && settings.declFilterTypes.includes(type);\n        input.addEventListener(\"change\", () => {\n          const selected = [];\n          const inputs = els.declDescTypes ? els.declDescTypes.querySelectorAll(\"input[type=checkbox]\") : [];\n          for (const checkbox of Array.from(inputs)) {\n            if (checkbox.checked) {\n              selected.push(String(checkbox.value || \"\").trim().toUpperCase());\n            }\n          }\n          state.settings = normalizeSettings({ ...settings, declFilterTypes: selected });\n          saveSettings(state.settings);\n          renderDeclDescPanelUi();\n        });\n\n        label.appendChild(input);\n        label.appendChild(document.createTextNode(type));\n        els.declDescTypes.appendChild(label);\n      }\n    }\n\n    const decls = getDeclsForDescriptionsModal();\n    const types = new Set((state.settings && Array.isArray(state.settings.declFilterTypes))\n      ? state.settings.declFilterTypes\n      : DEFAULT_SETTINGS.declFilterTypes);\n\n    const query = els.declDescSearch ? String(els.declDescSearch.value || \"\").trim().toLowerCase() : \"\";\n    const missingOnly = Boolean(els.declDescMissingOnly && els.declDescMissingOnly.checked);\n\n    const rows = [];\n    let totalRows = 0;\n    let missingRows = 0;\n\n    for (const decl of decls) {\n      if (!decl || typeof decl !== \"object\" || !decl.objectType || !decl.name) {\n        continue;\n      }\n\n      const objectType = String(decl.objectType || \"\").trim().toUpperCase();\n      if (objectType === \"STRUCT_FIELD\") {\n        const structType = String(decl.structObjectType || \"\").trim().toUpperCase();\n        if (structType && !types.has(structType)) {\n          continue;\n        }\n      } else if (!types.has(objectType)) {\n        continue;\n      }\n\n      totalRows += 1;\n\n      const techName = getDeclTechName(decl);\n      const scopeLabel = String(decl.scopeLabel || \"\");\n\n      const isStructField = isStructFieldDecl(decl);\n      if (!isStructField) {\n        const codeDescRaw = String(getDeclCodeDesc(decl) || \"\");\n        const userEntry = getDeclOverrideEntry(decl);\n        const userDescRaw = userEntry.text ? String(userEntry.text) : \"\";\n\n        const codeDesc = settings.normalizeDeclDesc ? normalizeDeclDescText(decl, codeDescRaw) : codeDescRaw;\n        const userDesc = (!settings.normalizeDeclDesc || userEntry.noNormalize)\n          ? userDescRaw\n          : normalizeDeclDescText(decl, userDescRaw);\n\n        const missing = !codeDescRaw.trim() && !userDescRaw.trim();\n        if (missing) {\n          missingRows += 1;\n        }\n        if (missingOnly && !missing) {\n          continue;\n        }\n\n        const haystack = [\n          objectType,\n          scopeLabel,\n          techName,\n          codeDescRaw,\n          userDescRaw,\n          codeDesc,\n          userDesc\n        ]\n          .filter(Boolean)\n          .join(\"\\n\")\n          .toLowerCase();\n\n        if (query && !haystack.includes(query)) {\n          continue;\n        }\n\n        rows.push({\n          decl,\n          objectType,\n          scopeLabel,\n          techName,\n          missing,\n          codeDesc,\n          userDesc\n        });\n        continue;\n      }\n\n      const structDecl = buildStructDeclFromFieldDecl(decl);\n      const structCodeRaw = structDecl ? String(getDeclCodeDesc(structDecl) || \"\") : \"\";\n      const structUserRaw = structDecl ? String(getDeclOverrideDesc(structDecl) || \"\") : \"\";\n      const itemCodeRaw = String(getDeclCodeDesc(decl) || \"\");\n      const itemEntry = getDeclOverrideEntry(decl);\n      const itemUserRaw = itemEntry.text ? String(itemEntry.text) : \"\";\n\n      const structCode = structDecl && settings.normalizeDeclDesc ? normalizeDeclDescText(structDecl, structCodeRaw) : structCodeRaw;\n      const structUser = structDecl && settings.normalizeDeclDesc ? normalizeDeclDescText(structDecl, structUserRaw) : structUserRaw;\n      const itemCode = settings.normalizeDeclDesc ? normalizeDeclDescText(decl, itemCodeRaw) : itemCodeRaw;\n      const itemUser = (!settings.normalizeDeclDesc || itemEntry.noNormalize)\n        ? itemUserRaw\n        : normalizeDeclDescText(decl, itemUserRaw);\n\n      const structMissing = !structCodeRaw.trim() && !structUserRaw.trim();\n      const itemMissing = !itemCodeRaw.trim() && !itemUserRaw.trim();\n      const missing = structMissing || itemMissing;\n      if (missing) {\n        missingRows += 1;\n      }\n      if (missingOnly && !missing) {\n        continue;\n      }\n\n      const haystack = [\n        objectType,\n        scopeLabel,\n        techName,\n        structCodeRaw,\n        structUserRaw,\n        itemCodeRaw,\n        itemUserRaw,\n        structCode,\n        structUser,\n        itemCode,\n        itemUser\n      ]\n        .filter(Boolean)\n        .join(\"\\n\")\n        .toLowerCase();\n\n      if (query && !haystack.includes(query)) {\n        continue;\n      }\n\n      rows.push({\n        decl,\n        objectType,\n        scopeLabel,\n        techName,\n        missing,\n        structMissing,\n        itemMissing,\n        structCode,\n        structUser,\n        itemCode,\n        itemUser\n      });\n    }\n\n    rows.sort((a, b) => {\n      const scopeCmp = String(a.scopeLabel || \"\").localeCompare(String(b.scopeLabel || \"\"));\n      if (scopeCmp) {\n        return scopeCmp;\n      }\n      const typeCmp = String(a.objectType || \"\").localeCompare(String(b.objectType || \"\"));\n      if (typeCmp) {\n        return typeCmp;\n      }\n      return String(a.techName || \"\").localeCompare(String(b.techName || \"\"));\n    });\n\n    if (els.declDescSummary) {\n      const shown = rows.length;\n      els.declDescSummary.textContent = `Showing ${shown} of ${totalRows} decls • Missing: ${missingRows}`;\n    }\n\n    if (!els.declDescTable) {\n      refreshInputGutterTargets();\n      return;\n    }\n\n    if (!state.data || !Array.isArray(state.data.objects)) {\n      els.declDescTable.replaceChildren(el(\"div\", { className: \"muted\", text: \"No data loaded. Click Render first.\" }));\n      refreshInputGutterTargets();\n      return;\n    }\n\n    const table = document.createElement(\"table\");\n    const thead = document.createElement(\"thead\");\n    const headRow = document.createElement(\"tr\");\n    for (const title of [\"type\", \"scope\", \"technical id\", \"code desc\", \"user desc\", \"\"]) {\n      const th = document.createElement(\"th\");\n      th.textContent = title;\n      headRow.appendChild(th);\n    }\n    thead.appendChild(headRow);\n    table.appendChild(thead);\n\n    const tbody = document.createElement(\"tbody\");\n    for (const row of rows) {\n      const tr = document.createElement(\"tr\");\n      const declKey = getDeclOverrideStorageKey(row.decl);\n      if (declKey) {\n        tr.setAttribute(\"data-decl-key\", declKey);\n        if (declKey === state.selectedDeclKey) {\n          tr.classList.add(\"desc-selected\");\n        }\n      }\n      if (row.decl && row.decl.lineStart) {\n        tr.setAttribute(\"data-line-start\", String(row.decl.lineStart));\n      }\n\n      const typeCell = document.createElement(\"td\");\n      typeCell.textContent = row.objectType || \"\";\n      tr.appendChild(typeCell);\n\n      const scopeCell = document.createElement(\"td\");\n      scopeCell.textContent = row.scopeLabel || \"\";\n      tr.appendChild(scopeCell);\n\n      const idCell = document.createElement(\"td\");\n      const idWrap = document.createElement(\"div\");\n      const idLine = document.createElement(\"div\");\n      idLine.textContent = row.techName || \"\";\n      const title = buildDeclTitle(row.decl);\n      if (title) {\n        idLine.title = title;\n      }\n      if (row.decl && row.decl.lineStart) {\n        idLine.style.cursor = \"pointer\";\n        idLine.addEventListener(\"click\", (ev) => {\n          ev.stopPropagation();\n          selectCodeLines(row.decl.lineStart, row.decl.lineStart);\n          if (row.decl.id) {\n            setSelectedCard(row.decl.id);\n          }\n        });\n      }\n      idWrap.appendChild(idLine);\n\n      if (row.objectType === \"STRUCT_FIELD\") {\n        const pills = document.createElement(\"div\");\n        if (row.structMissing) {\n          pills.appendChild(el(\"span\", { className: \"pill\", text: \"struct missing\" }));\n        }\n        if (row.itemMissing) {\n          pills.appendChild(el(\"span\", { className: \"pill\", text: \"item missing\" }));\n        }\n        if (pills.childNodes.length) {\n          idWrap.appendChild(pills);\n        }\n      } else if (row.missing) {\n        idWrap.appendChild(el(\"span\", { className: \"pill\", text: \"missing\" }));\n      }\n\n      idCell.appendChild(idWrap);\n      tr.appendChild(idCell);\n\n      const codeCell = document.createElement(\"td\");\n      if (row.objectType === \"STRUCT_FIELD\") {\n        codeCell.appendChild(renderDeclDescCellLines({ structText: row.structCode || \"\", itemText: row.itemCode || \"\" }));\n      } else {\n        codeCell.textContent = row.codeDesc || \"\";\n      }\n      tr.appendChild(codeCell);\n\n      const userCell = document.createElement(\"td\");\n      if (row.objectType === \"STRUCT_FIELD\") {\n        userCell.appendChild(renderDeclDescCellLines({ structText: row.structUser || \"\", itemText: row.itemUser || \"\" }));\n      } else {\n        userCell.textContent = row.userDesc || \"\";\n      }\n      tr.appendChild(userCell);\n\n      const actionCell = document.createElement(\"td\");\n      const btn = el(\"button\", {\n        className: \"icon-btn\",\n        text: \"✎\",\n        attrs: { type: \"button\", title: \"Edit description\", \"aria-label\": \"Edit description\" }\n      });\n      btn.addEventListener(\"click\", (ev) => {\n        ev.stopPropagation();\n        editDeclDesc(row.decl);\n      });\n      actionCell.appendChild(btn);\n      tr.appendChild(actionCell);\n\n      tbody.appendChild(tr);\n    }\n    table.appendChild(tbody);\n\n    els.declDescTable.replaceChildren(table);\n    refreshInputGutterTargets();\n  }\n\n  function setRightTab(nextTab) {\n    const tab = nextTab === \"descriptions\"\n      ? \"descriptions\"\n      : (nextTab === \"template\" ? \"template\" : \"output\");\n    state.rightTab = tab;\n\n    const showDescriptions = tab === \"descriptions\";\n    const showTemplate = tab === \"template\";\n    const showOutput = tab === \"output\";\n    if (els.output) {\n      els.output.hidden = !showOutput;\n    }\n    if (els.templatePreviewPanel) {\n      els.templatePreviewPanel.hidden = !showTemplate;\n    }\n    if (els.declDescPanel) {\n      els.declDescPanel.hidden = !showDescriptions;\n    }\n\n    if (els.rightPanelTitle) {\n      els.rightPanelTitle.textContent = showDescriptions\n        ? \"Descriptions\"\n        : (showTemplate ? \"Template Preview\" : \"Output\");\n    }\n\n    if (els.rightTabOutputBtn) {\n      els.rightTabOutputBtn.classList.toggle(\"active\", showOutput);\n      els.rightTabOutputBtn.setAttribute(\"aria-selected\", String(showOutput));\n    }\n    if (els.rightTabTemplateBtn) {\n      els.rightTabTemplateBtn.classList.toggle(\"active\", showTemplate);\n      els.rightTabTemplateBtn.setAttribute(\"aria-selected\", String(showTemplate));\n    }\n    if (els.rightTabDescBtn) {\n      els.rightTabDescBtn.classList.toggle(\"active\", showDescriptions);\n      els.rightTabDescBtn.setAttribute(\"aria-selected\", String(showDescriptions));\n    }\n    if (els.declDescJsonBtn) {\n      els.declDescJsonBtn.hidden = !showDescriptions;\n    }\n\n    if (showDescriptions) {\n      renderDeclDescPanelUi();\n      setTimeout(() => {\n        if (els.declDescSearch) {\n          els.declDescSearch.focus();\n        }\n      }, 0);\n    } else if (showTemplate) {\n      renderTemplatePreview();\n    }\n\n    refreshInputGutterTargets();\n  }\n\n  function applySettingsFromModal() {\n    if (!els.settingsModal) {\n      return;\n    }\n\n    const next = {\n      normalizeDeclDesc: Boolean(els.settingsNormalizeDesc && els.settingsNormalizeDesc.checked),\n      declFilterTypes: [],\n      structDescTemplate: (els.settingsStructTemplate && els.settingsStructTemplate.value)\n        ? String(els.settingsStructTemplate.value || \"\")\n        : DEFAULT_SETTINGS.structDescTemplate,\n      nameTemplatesByCode: {}\n    };\n\n    if (els.settingsDeclTypes) {\n      const inputs = els.settingsDeclTypes.querySelectorAll(\"input[type=checkbox]\");\n      for (const input of Array.from(inputs)) {\n        if (input.checked) {\n          next.declFilterTypes.push(String(input.value || \"\").trim().toUpperCase());\n        }\n      }\n    }\n\n";
})(typeof globalThis !== "undefined" ? globalThis : (typeof self !== "undefined" ? self : this));
