"use strict";

(function (root) {
  const globalRoot = root || (typeof globalThis !== "undefined" ? globalThis : this);
  const registry = globalRoot.__AbapSourceParts = globalRoot.__AbapSourceParts || {};
  const targetKey = "viewer/app/04-output-render.js";
  const partKey = "viewer/app/output/07-render-tree.js";
  const bucket = registry[targetKey] = registry[targetKey] || {};
  bucket[partKey] = "          wrap.appendChild(table);\n        }\n      }\n\n      return wrap;\n    }\n\n    if (extras.ifCondition) {\n      const info = extras.ifCondition;\n      appendConditionSection(\n        wrap,\n        \"conditions\",\n        info.conditionRaw ? `IF ${info.conditionRaw}` : \"\",\n        info.conditions,\n        { obj, extrasScope: \"ifCondition\" }\n      );\n      return wrap;\n    }\n\n    if (extras.select) {\n      const info = extras.select;\n      appendConditionSection(\n        wrap,\n        \"whereConditions\",\n        info.whereRaw ? `WHERE ${info.whereRaw}` : \"\",\n        info.whereConditions,\n        { obj, extrasScope: \"select.where\" }\n      );\n      appendConditionSection(\n        wrap,\n        \"havingConditions\",\n        info.havingRaw ? `HAVING ${info.havingRaw}` : \"\",\n        info.havingConditions,\n        { obj, extrasScope: \"select.having\" }\n      );\n      return wrap;\n    }\n\n    if (extras.readTable) {\n      const info = extras.readTable;\n      const raw = info.withTableKeyRaw\n        ? `WITH TABLE KEY ${info.withTableKeyRaw}`\n        : (info.withKeyRaw ? `WITH KEY ${info.withKeyRaw}` : \"\");\n      appendConditionSection(wrap, \"conditions\", raw, info.conditions, { obj, extrasScope: \"readTable\" });\n      return wrap;\n    }\n\n    if (extras.loopAtItab) {\n      const info = extras.loopAtItab;\n      appendConditionSection(\n        wrap,\n        \"conditions\",\n        info.whereRaw ? `WHERE ${info.whereRaw}` : \"\",\n        info.conditions,\n        { obj, extrasScope: \"loopAtItab\" }\n      );\n      return wrap;\n    }\n\n    if (extras.modifyItab) {\n      const info = extras.modifyItab;\n      appendConditionSection(\n        wrap,\n        \"conditions\",\n        info.whereRaw ? `WHERE ${info.whereRaw}` : \"\",\n        info.conditions,\n        { obj, extrasScope: \"modifyItab\" }\n      );\n      return wrap;\n    }\n\n    if (extras.deleteItab) {\n      const info = extras.deleteItab;\n      appendConditionSection(\n        wrap,\n        \"conditions\",\n        info.whereRaw ? `WHERE ${info.whereRaw}` : \"\",\n        info.conditions,\n        { obj, extrasScope: \"deleteItab\" }\n      );\n      return wrap;\n    }\n\n    wrap.appendChild(el(\"pre\", { text: safeJson(extras, true) }));\n    return wrap;\n  }\n\n  function renderMeta(obj) {\n    const parts = [];\n    if (obj.file) {\n      parts.push(String(obj.file));\n    }\n    if (obj.lineStart) {\n      parts.push(`line ${obj.lineStart}`);\n    }\n    if (obj.block && obj.block.lineEnd) {\n      parts.push(`end ${obj.block.lineEnd}`);\n    }\n    if (obj.id !== undefined && obj.id !== null) {\n      parts.push(`#${obj.id}`);\n    }\n    return parts.join(\" â€¢ \");\n  }\n\n  function getObjectLabel(obj) {\n    for (const key of [\"name\", \"target\", \"form\"]) {\n      const value = getFirstValueFromValues(obj.values, key);\n      if (value) {\n        return value;\n      }\n    }\n\n    if (obj.extras && obj.extras.callFunction && obj.extras.callFunction.name) {\n      return String(obj.extras.callFunction.name);\n    }\n    if (obj.extras && obj.extras.callMethod && obj.extras.callMethod.target) {\n      return String(obj.extras.callMethod.target);\n    }\n    if (obj.extras && obj.extras.performCall && obj.extras.performCall.form) {\n      return String(obj.extras.performCall.form);\n    }\n    if (obj.extras && obj.extras.form && obj.extras.form.name) {\n      return String(obj.extras.form.name);\n    }\n    if (obj.extras && obj.extras.methodSignature && obj.extras.methodSignature.name) {\n      return String(obj.extras.methodSignature.name);\n    }\n\n    return \"\";\n  }\n\n  function renderNode(nodeInfo) {\n    const obj = nodeInfo.obj;\n    const id = normalizeId(obj.id);\n    const children = nodeInfo.children || [];\n\n    const cardAttrs = {};\n    if (id) {\n      cardAttrs[\"data-id\"] = id;\n    }\n    if (obj && obj.lineStart) {\n      cardAttrs[\"data-line-start\"] = String(obj.lineStart);\n    }\n\n    const card = el(\"div\", {\n      className: `card${obj.block ? \" block\" : \"\"}${id && id === state.selectedId ? \" selected\" : \"\"}`,\n      attrs: Object.keys(cardAttrs).length ? cardAttrs : {}\n    });\n\n    const header = el(\"div\", { className: \"card-header\" });\n    const label = getObjectLabel(obj);\n    const titleText = `${String(obj.objectType || \"(unknown)\")}${label ? ` ${label}` : \"\"}`;\n    const title = el(\"h3\", { className: \"card-title\", text: titleText });\n\n    const meta = renderMeta(obj);\n    if (meta) {\n      title.appendChild(el(\"span\", { className: \"muted\", text: `  (${meta})` }));\n    }\n\n    header.appendChild(title);\n\n    const actions = el(\"div\", { className: \"card-actions\" });\n\n    const btnCode = el(\"button\", { className: \"btn-ghost\", text: \"Code\" });\n    btnCode.type = \"button\";\n    btnCode.addEventListener(\"click\", (ev) => {\n      ev.stopPropagation();\n      setSelectedCard(id);\n      const lineEnd = obj.block && obj.block.lineEnd ? obj.block.lineEnd : obj.lineStart;\n      selectCodeLines(obj.lineStart, lineEnd);\n    });\n    actions.appendChild(btnCode);\n\n    const btnJson = el(\"button\", { className: \"btn-ghost\", text: \"JSON\" });\n    btnJson.type = \"button\";\n    btnJson.addEventListener(\"click\", (ev) => {\n      ev.stopPropagation();\n      setSelectedCard(id);\n      openJsonModal(obj);\n    });\n    actions.appendChild(btnJson);\n\n    if (children.length) {\n      const isCollapsed = state.collapsedIds.has(id);\n      const btnCollapse = el(\"button\", { className: \"btn-ghost\", text: isCollapsed ? \"Expand\" : \"Collapse\" });\n      btnCollapse.type = \"button\";\n      btnCollapse.addEventListener(\"click\", (ev) => {\n        ev.stopPropagation();\n        if (state.collapsedIds.has(id)) {\n          state.collapsedIds.delete(id);\n        } else {\n          state.collapsedIds.add(id);\n        }\n        renderOutput();\n        setSelectedCard(id);\n      });\n      actions.appendChild(btnCollapse);\n    }\n\n    header.appendChild(actions);\n    card.appendChild(header);\n\n    if (obj.comment) {\n      card.appendChild(el(\"div\", { className: \"muted\", text: String(obj.comment) }));\n    }\n\n    if (state.showKeywords) {\n      const kw = renderKeywords(obj);\n      if (kw) {\n        card.appendChild(kw);\n      }\n    }\n\n    if (state.showValues) {\n      const valuesTable = renderValues(obj);\n      if (valuesTable) {\n        card.appendChild(valuesTable);\n      }\n    }\n\n    if (state.showRaw && obj.raw) {\n      card.appendChild(el(\"div\", { className: \"raw\", text: String(obj.raw) }));\n    }\n\n    if (state.showExtras) {\n      const extras = renderExtras(obj);\n      if (extras) {\n        card.appendChild(extras);\n      }\n    }\n\n    if (children.length && !state.collapsedIds.has(id)) {\n      const childWrap = el(\"div\", { className: \"children\" });\n      for (const child of children) {\n        childWrap.appendChild(renderNode(child));\n      }\n      card.appendChild(childWrap);\n    }\n\n    card.addEventListener(\"click\", () => setSelectedCard(id));\n    return card;\n  }\n\n  function populateTypeFilter(objects) {\n    const types = new Set();\n    walkObjects(objects, (obj) => {\n      if (obj && obj.objectType) {\n        types.add(String(obj.objectType));\n      }\n    });\n\n    const sorted = Array.from(types).sort((a, b) => a.localeCompare(b));\n    const current = els.typeFilter.value || \"\";\n\n    while (els.typeFilter.options.length > 1) {\n      els.typeFilter.remove(1);\n    }\n\n    for (const type of sorted) {\n      const opt = document.createElement(\"option\");\n      opt.value = type;\n      opt.textContent = type;\n      els.typeFilter.appendChild(opt);\n    }\n\n    els.typeFilter.value = sorted.includes(current) ? current : \"\";\n  }\n\n  function renderOutput() {\n    const scrollTop = els.output.scrollTop;\n    setError(\"\");\n\n    if (!state.data || !Array.isArray(state.renderObjects)) {\n      setOutputMessage(\"No data loaded.\");\n      refreshInputGutterTargets();\n      return;\n    }\n\n    state.query = (els.searchInput.value || \"\").trim().toLowerCase();\n    state.type = els.typeFilter.value || \"\";\n    state.showRaw = Boolean(els.showRaw && els.showRaw.checked);\n    state.showKeywords = Boolean(els.showKeywords && els.showKeywords.checked);\n    state.showValues = Boolean(els.showValues && els.showValues.checked);\n    state.showExtras = Boolean(els.showExtras && els.showExtras.checked);\n\n    const filteredRoots = (state.renderObjects || [])\n      .map((obj) => filterTree(obj))\n      .filter(Boolean);\n\n    if (!filteredRoots.length) {\n      setOutputMessage(\"No matches.\");\n      refreshInputGutterTargets();\n      return;\n    }\n\n    const frag = document.createDocumentFragment();\n    for (const root of filteredRoots) {\n      frag.appendChild(renderNode(root));\n    }\n\n    els.output.classList.remove(\"muted\");\n    els.output.replaceChildren(frag);\n    els.output.scrollTop = scrollTop;\n\n    if (state.selectedId) {\n      setSelectedCard(state.selectedId, { scroll: false });\n    }\n\n    refreshInputGutterTargets();\n  }\n\n  function normalizeParsedJson(json) {\n    if (Array.isArray(json)) {\n      return { file: \"\", objects: json, decls: [] };\n    }\n    if (json && typeof json === \"object\" && Array.isArray(json.objects)) {\n      return {\n        file: String(json.file || \"\"),\n        objects: json.objects,\n        decls: Array.isArray(json.decls) ? json.decls : []\n      };\n    }\n    return null;\n  }\n\nwindow.AbapViewerModules.factories = window.AbapViewerModules.factories || {};\nwindow.AbapViewerModules.factories[\"04-output-render\"] = function registerOutputRender(runtime) {\n  const targetRuntime = runtime || (window.AbapViewerRuntime = window.AbapViewerRuntime || {});\n  targetRuntime.api = targetRuntime.api || {};\n  targetRuntime.api.renderOutput = renderOutput;\n  targetRuntime.api.buildAbapFlowXml = buildAbapFlowXml;\n  targetRuntime.api.setRightTab = setRightTab;\n  window.AbapViewerModules.parts[\"04-output-render\"] = true;\n};\nwindow.AbapViewerModules.factories[\"04-output-render\"](window.AbapViewerRuntime);\n\n";
})(typeof globalThis !== "undefined" ? globalThis : (typeof self !== "undefined" ? self : this));
