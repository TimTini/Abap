#!/usr/bin/env node
"use strict";

const fs = require("fs");
const path = require("path");

const repoRoot = path.resolve(__dirname, "..");
const configsDir = path.join(repoRoot, "configs");
const outDir = path.join(repoRoot, "viewer", "configs.generated");
const indexHtmlFile = path.join(repoRoot, "viewer", "index.html");

const START_MARKER = "<!-- abap-parser-configs:start -->";
const END_MARKER = "<!-- abap-parser-configs:end -->";

function escapeRegExp(text) {
  return String(text).replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
}

function readJsonFiles(dir) {
  const entries = fs.readdirSync(dir, { withFileTypes: true });
  return entries
    .filter((e) => e.isFile() && e.name.toLowerCase().endsWith(".json"))
    .map((e) => e.name)
    .sort((a, b) => a.localeCompare(b));
}

function loadConfig(fileName) {
  const fullPath = path.join(configsDir, fileName);
  const raw = fs.readFileSync(fullPath, "utf8");
  const parsed = JSON.parse(raw);

  return {
    _sourceFile: fileName,
    ...parsed
  };
}

function jsFileNameFromJsonFileName(jsonFileName) {
  return jsonFileName.replace(/\.json$/i, ".js");
}

function formatConfigFileJs(config) {
  const lines = [
    "/* eslint-disable */",
    "/*",
    "  AUTO-GENERATED FILE",
    "",
    "  Source: /configs/*.json",
    "  Generator: /scripts/build-viewer-configs.js",
    "",
    "  Do not edit this file directly. Regenerate instead.",
    "*/",
    "",
    "(function () {",
    '  "use strict";',
    "",
    "  if (!window.AbapParser || typeof window.AbapParser.registerConfig !== \"function\") {",
    `    console.warn("AbapParser not loaded; config not registered: ${String(config._sourceFile || "")}");`,
    "    return;",
    "  }",
    "",
    "  const config = " + JSON.stringify(config, null, 2).replace(/\n/g, "\n  ") + ";",
    "  window.AbapParser.registerConfig(config);",
    "})();",
    ""
  ];

  return lines.join("\n");
}

function detectNewline(text) {
  return text.includes("\r\n") ? "\r\n" : "\n";
}

function updateViewerIndexHtml(configJsFileNames) {
  if (!fs.existsSync(indexHtmlFile)) {
    console.error(`Missing viewer index.html: ${indexHtmlFile}`);
    process.exit(1);
  }

  const original = fs.readFileSync(indexHtmlFile, "utf8");
  const newline = detectNewline(original);

  const scriptLines = configJsFileNames.map((name) => `<script src="./configs.generated/${name}" defer></script>`);

  const pattern = new RegExp(
    `^([ \\t]*)${escapeRegExp(START_MARKER)}[\\s\\S]*?^[ \\t]*${escapeRegExp(END_MARKER)}`,
    "m"
  );
  const match = original.match(pattern);
  if (!match) {
    console.error("Missing or invalid config markers in viewer/index.html.");
    console.error(`Expected markers: ${START_MARKER} ... ${END_MARKER}`);
    process.exit(1);
  }

  const indent = match[1] || "";
  const replacement = [START_MARKER, ...scriptLines, END_MARKER]
    .map((line) => `${indent}${line}`)
    .join(newline);

  const next = original.replace(pattern, replacement);
  fs.writeFileSync(indexHtmlFile, next, "utf8");
}

function main() {
  if (!fs.existsSync(configsDir)) {
    console.error(`Missing configs dir: ${configsDir}`);
    process.exit(1);
  }

  const fileNames = readJsonFiles(configsDir);
  if (!fileNames.length) {
    console.error(`No .json configs found in: ${configsDir}`);
    process.exit(1);
  }

  const configs = fileNames.map(loadConfig);
  const outFileNames = fileNames.map(jsFileNameFromJsonFileName);

  fs.mkdirSync(outDir, { recursive: true });

  for (const config of configs) {
    const outName = jsFileNameFromJsonFileName(String(config._sourceFile || ""));
    const outPath = path.join(outDir, outName);
    const js = formatConfigFileJs(config);
    fs.writeFileSync(outPath, js, "utf8");
  }

  updateViewerIndexHtml(outFileNames);

  console.log(`Generated ${path.relative(repoRoot, outDir)}\\*.js (${configs.length} configs)`);
}

main();
